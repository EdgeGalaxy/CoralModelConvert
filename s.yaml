edition: 3.0.0
name: coral-model-convert
access: default

# 使用 Serverless Devs (s) 部署到阿里云函数计算 FC（自定义容器）
# 参考：s deploy -y

resources:
  coral-model-convert:
    component: fc3
    props:
      region: cn-hangzhou  # 按需修改区域

      service:
        name: coral-convert-svc
        description: FastAPI model convert service (custom container)
        internetAccess: true
        role: auto
        logConfig: auto  # 自动创建 SLS 日志项目与日志库

      function:
        name: coral-convert
        description: FastAPI + Uvicorn (Docker image)
        runtime: custom-container
        code:
          src: ./
        # 使用环境变量注入镜像地址，便于 CI/CD 中安全替换
        customContainerConfig:
          image: ${env(ACR_IMAGE)}
          command:
            - /app/bootstrap
          port: 8000
        # 资源规格按需调整
        timeout: 600           # 单次请求超时时间（秒）
        memorySize: 8192       # MB
        cpu: 4                 # vCPU
        diskSize: 512          # MB，实例临时磁盘
        instanceConcurrency: 5 # 单实例并发
        environmentVariables:
          # FC 会注入 FC_SERVER_PORT；bootstrap 中已使用该变量
          HOST: 0.0.0.0
          PORT: "8000"
          # 敏感 OSS 配置通过环境变量注入（来自 CI Secrets）
          OSS_ACCESS_KEY_ID: ${env(OSS_ACCESS_KEY_ID)}
          OSS_ACCESS_KEY_SECRET: ${env(OSS_ACCESS_KEY_SECRET)}
          OSS_ENDPOINT: ${env(OSS_ENDPOINT)}
          OSS_BUCKET_NAME: ${env(OSS_BUCKET_NAME)}

      triggers:
        - name: httpTrigger
          type: http
          config:
            authType: anonymous
            methods: [GET, POST, PUT, DELETE, PATCH]
            enableCors: true

      # 如需自定义域名，可按需开启（可选）
      # customDomains:
      #   - domainName: auto
      #     protocol: HTTP
      #     routeConfigs:
      #       - path: /
